[English README](README.md)


# InnoSchedule телеграм бот

[@InnoSchedule_bot](https://t.me/InnoSchedule_bot)

Этот бот написан для студентов университета Иннополис. Имеет модульную архитектуру, что позволяет любому желающему добавить свой модуль.


# Как это работает

- `python3` разработка велась на версии 3.7
- `PyTelegramBotAPI` для работы с api телеграма
- `sqlalchemy` ORM
- `sqlite3` база данных


# Существующие модули

На данный момент есть 5 модулей:
1. `core` головной модуль, который связывает все воедино. Содержит весь необходимый для работы других модулей функционал:
    - работа с Telegram API
    - логирование
    - установка соединение с базой данных
2. `admin` содержит команды для админов. К примеру, вывод статистики или массовая рассылка уведомлений
3. `schedule` позволяет получать расписание занятий на конкретное время или день недели, а так же смотреть расписание друзей
4. `remind` рассылает напоминания о скором начале занятия
5. `sample` является рабочим примером простейшего модуля. Будет полезен тем, кто хочет добавить свой модуль
6. `autoparses` автоматически парсит расписание с google таблиц

# Установка и запуск

```bash
git clone https://gitlab.com/Louie_ru/InnoSchedule
cd InnoSchedule
pip3 install -r requirements.txt
```
Изменить токен в modules/admin/permanent.py на токен своего тестового бота, который можно получить от [@BotFather](https://t.me/BotFather)
```bash
python3 InnoSchedule.py
```


# Как добавить свой модуль?

Перед созданием своего модуля рекомендуется почитать документацию используемых библиотек:

- [PyTelegramBotAPI](https://github.com/eternnoir/pyTelegramBotAPI)
- [sqlalchemy query API](https://docs.sqlalchemy.org/en/latest/orm/query.html)
- [sqlalchemy relationship patterns](https://docs.sqlalchemy.org/en/latest/orm/basic_relationships.html)

Каждый модуль состоит из 4 частей:

1. `source.py` основной код для регистрации команд и функций для работы с пользователями
2. `classes.py` классы, используемые модулем. Описываются в формате sqlalchemy для отображения в базу
3. `controller.py` функции для работы с базой данных. Основной код работает с базой не напрямую, а через контроллер
4. `permanent.py` хранит все константные значения, такие как строки, настройки модуля и т.д.

Для добавления модуля в основную ветку, необходимо сделать fork репозитория и предложить свой pull request.
За основу можно взять `sample` модуль, скопировать и изменять его под свои цели.
По любым вопросам можете писать разработчику.


# Технические детали разработки:

1. **classes.py**
    - имена всех таблиц должны начинаться на %modulename%
    - все классы для сохранения в бд должны наследоваться от Base из `core` модуля
2. **controller.py**
    - `core` модуль предоставляет декораторы _db_read_ и _db_write_, которые сами выделяют соединение из dbcp, делают commit, закрывают и возвращают соединение в dbcp. Они добавляют в начало параметров session, который не нужно передавать при вызове функций.
    - желательно детально документировать функции контроллера, т.к. другие модули могут впоследствии их использовать
    - если функция возвращает объект из базы, то важно понимать, что при завершении функции сессия закрывается, и orm не сможет подгрузить другие объекты, связанные с данным. Желательно сразу загружать все нужные данные. В противном случае можно изменить настройки lazyload (см. документацию sqlalchemy)
3. **permanent.py**
    - все константы имеют название в верхнем регистре
    - желательно именовать строки по шаблонам
        * _MESSAGE__ уведомления, отправляемые пользователям
        * _REQUEST__ вопросы, отправляемые пользователям
        * _TEXT__ остальные строки
4. **source.py**
    - в начале кода нужно кратко описать возможности модуля и указать автора
    - весь код нужно расположить внутри функции *attach_%modulename%_module*

Для подключения модуля, нужно импортировать его в `InnoSchedule.py` и добавить краткое описание в этот readme.


# Общие правила, которые необходимо помнить

- Не изменять чужие модули без разрешения разработчиков этих модулей
- Не слать сообщения людям без их разрешения. Если модуль сам иногда рассылает сообщения, то должна быть возможность отключить их
- Без рекламы
- Все сообщения бота и комментарии в коде на английском. Можно предложить выбрать язык, но английский быть обязан
- Документировать код и использовать понятные названия, чтобы ваш модуль могли использовать другие разработчики
- Желательно следовать стилю PEP8


# Контакты

Telegram:

[@Nmikriukov](https://t.me/Nmikriukov) - главный разработчик

[@thedownhill](https://t.me/thedownhill) - сосед главного разработчика
